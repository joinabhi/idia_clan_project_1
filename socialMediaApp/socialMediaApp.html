<!DOCTYPE html>
<html>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65" crossorigin="anonymous">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-kenU1KFdBIe4zVF0s0G1M5b4hcpxyD9F7jL+jjXkk+Q2h455rYXK/7HAuoJl+0I4"
    crossorigin="anonymous"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
<style>
    .pure-form {
        border-radius: 5px;
        background-color: #f2f2f2;
        padding: 20px;
    }

    table,
    th,
    tr {
        border: 1px solid black;
    }
</style>

<body>
    <form onsubmit="formSubmit(event)" class="pure-form">
        <fieldset>
            <label>Create a post:</label><br>
            <input type="text" placeholder="Your Post" name="name" id="nameIdd" required /><br>
            <button style="background-color:blue; border-color:red; color:white">Submit</button>
        </fieldset>
    </form>

    <h1>Recent Posts</h1>
    <ul id="todoCompleted"></ul>
    <h1>Follower Posts</h1>
    <ul id="followerPost"></ul>
    <h1>All Users</h1>
    <ul id="allUsers"></ul>
    <div id="counter">Following: 0</div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/graphql-request/3.5.0/graphql-request.min.js"></script>
    <script>


        async function request(url, query, variables, headers) {
            const response = await fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    ...headers // Spread the headers object here
                },
                body: JSON.stringify({ query, variables }),
            });
            return await response.json();
        }


        async function formSubmit(event) {
            event.preventDefault();
            const post = event.target.name.value;

            const mutation = `
        mutation CreatePost($post: String!) {
        createPost(body: $post) {
            id
            username
            body
        }
    }
`;
            const variables = {
                post: post
            };

            console.log("7777771111111111", variables)
            try {
                const token = localStorage.getItem('token');
                const decodeToken = parseJwt(token);
                console.log("145****", decodeToken)
                const data = await request('http://localhost:7000/graphql', mutation, variables, { Authorization: `Bearer ${token}` });

                console.log('Post added successfully:', data);
                showUserOnScreen(data.data.createPost);
                document.forms[0].reset();
            } catch (error) {
                console.error('Error adding post:', error);
            }
        }


        async function fetchAllPosts() {
            const query = `
                {
                    getPosts {
                        id
                        username
                        body
                        user
                    }
                }
            `;
            try {
                const token = localStorage.getItem('token')
                const decodedToken = parseJwt(token);
                const data = await request('http://localhost:7000/graphql', query, { Authorization: `Bearer ${token}` });
                console.log('Fetched all posts:', data);
                const allPost=data.data.getPosts.filter(post=>post.user===decodedToken.id)
                console.log("105--------------<><><>", allPost)
                allPost.forEach(post => showUserOnScreen(post));
            } catch (error) {
                console.error('Error fetching posts:', error);
            }
        }
        window.addEventListener('DOMContentLoaded', fetchAllPosts);

        async function fetchAllUsers() {
            const query = `{
            getUsers{
                id
                username
                email
             }
           }
        `;
            console.log("query of allUsers", query)
            try {
                const token = localStorage.getItem('token')
                const decodeToken = parseJwt(token);
                console.log("128****----------->", decodeToken)
                const data = await request("http://localhost:7000/graphql", query)
                const users = data.data.getUsers.filter(user => user.id !== decodeToken.id);
                console.log("users h", users)
                users.forEach(user => showUserOnScreenforFandUF(user));
            } catch (error) {
                console.error("Error fetching Users", error)

            }
        }

        window.addEventListener("DOMContentLoaded", fetchAllUsers)

        async function deletePost(postId) {
            const mutation = `
        mutation DeletePost($postId: ID!) {
            deletePost(postId: $postId)
        }
    `;

            console.log("data for delete", mutation)

            try {
                const token = localStorage.getItem('token')
                const data = await request('http://localhost:7000/graphql', mutation, { postId: postId }, { Authorization: `Bearer ${token}` })
                console.log("get data ka response", data)
                const postElem = document.getElementById(`post-${postId}`);
                console.log("postId--->", postId, "postElem--->", postElem)
                postElem.parentNode.removeChild(postElem);
            } catch (error) {
                console.error('Error deleting post:', error);
            }
        }

        function parseJwt(token) {
            console.log('141', token)
            var base64Url = token.split('.')[1];
            var base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
            var jsonPayload = decodeURIComponent(window.atob(base64).split('').map(function (c) {
                return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
            }).join(''));

            return JSON.parse(jsonPayload);
        }

        let counter = 0; // Initialize the counter
        function followAndUnfollowUserforCount(action) {
            if (action === 'follow') {
                counter++;
            } else if (action === 'unfollow') {
                if (counter > 0) {
                    counter--;
                }
            }
            document.getElementById('counter').innerText = "Following: " + counter;
        }


        //     async function followAndUnfollowUser(userId, action) {
        //         try {
        //             const query = `
        //     getPosts {
        //             ${action}(userId: "${userId}") {
        //                 id
        //                 username
        //                 // Add other user fields if needed
        //             }
        //         }
        // `;
        //             console.log("199______-->", query)

        //             const token = localStorage.getItem('token');
        //             const data = await request('http://localhost:7000/graphql', query, { userId: userId }, { Authorization: `Bearer ${token}` });
        //             console.log(`${action} user result:`, data);
        //             // Update UI based on action
        //             if (action === 'follow') {
        //                 // Disable follow button and enable unfollow button
        //                 document.getElementById(`followBtn-${userId}`).disabled = true;
        //                 document.getElementById(`unfollowBtn-${userId}`).disabled = false;
        //             } else {
        //                 // Disable unfollow button and enable follow button
        //                 document.getElementById(`unfollowBtn-${userId}`).disabled = true;
        //                 document.getElementById(`followBtn-${userId}`).disabled = false;
        //             }
        //         } catch (error) {
        //             console.error(`Error ${action}ing user:`, error);
        //         }
        //     }

        async function followAndUnfollowUser1(followerId) {
            try {
                console.log('followerId:', followerId);
                const token = localStorage.getItem('token');
                const decodedToken = parseJwt(token);
                console.log('decodeToken in follower', decodedToken)
                const followingId = decodedToken.id; // Assuming userId is stored in token
                console.log('followingId:', followingId);
                const mutation = `
            mutation FollowUser($followingId: ID!, $followerId: ID!) {
                followUser(followingId: $followingId, followerId: $followerId) {
                    id
                    email
                    username
                    createdAt
                }
            }
        `;


                console.log("232((((((((((()))))))))))", mutation)

                const variables = {
                    followingId: String(followingId),
                    followerId: String(followerId)
                };
                console.log("235################------>", variables)
                const data = await request('http://localhost:7000/graphql', mutation, variables, { Authorization: `Bearer ${token}` });
                console.log('data from followAndUnfollowUser', data);
            } catch (error) {
                console.error(error);
            }
        }

        async function followAndUnfollowUser2(followerId) {
            try {
                console.log('followerId:', followerId);
                const token = localStorage.getItem('token');
                const decodedToken = parseJwt(token);
                console.log('decodeToken in follower', decodedToken)
                const followingId = decodedToken.id; // Assuming userId is stored in token
                console.log('followingId:', followingId);
                const mutation = `
            mutation UnfollowUser($followingId: ID!, $followerId: ID!) {
                unfollowUser(followingId: $followingId, followerId: $followerId) {
                    id
                    email
                    username
                    createdAt
                }
            }
        `;


                console.log("232((((((((((()))))))))))", mutation)

                const variables = {
                    followingId: String(followingId),
                    followerId: String(followerId)
                };
                console.log("235################------>", variables)
                const data = await request('http://localhost:7000/graphql', mutation, variables, { Authorization: `Bearer ${token}` });
                console.log('data from followAndUnfollowUser', data);

            } catch (error) {
                console.error(error);
            }
        }

        async function fetchFollowedPosts(followerId) {
            const query = `
            query {
                getPosts {
                    id
                    username
                    body
                    user
                }
            }
        `;
            try {
                const token = localStorage.getItem('token');
                const data = await request('http://localhost:7000/graphql', query, { Authorization: `Bearer ${token}` });
                console.log('Fetch followed posts:', data);
                console.log("311111111111111111", data)
                const posts = data.data.getPosts.filter(user => user.user === followerId);
                console.log("users h", posts)
                posts.forEach(post => showUserOnScreen2(post));
            } catch (error) {
                console.error('Error fetching posts:', error);
            }
        }


        async function fetchFollowedPosts2(followerId) {
            const query = `
            query {
                getPosts {
                    id
                    username
                    body
                    user
                }
            }
        `;
            try {
                const token = localStorage.getItem('token');
                const data = await request('http://localhost:7000/graphql', query, { followerId: followerId }, { Authorization: `Bearer ${token}` });
                console.log('Fetch followed posts:', data);

                const posts = data.data.getPosts.filter(user => user.user === followerId);
                console.log("users h", posts)
                posts.forEach(post => {
                    const postElem = document.getElementById(`post-${post.id}`);
                    if (postElem) {
                        postElem.parentNode.removeChild(postElem);
                    }
                })
            } catch (error) {
                console.error('Error fetching posts:', error);
            }
        }

    //   window.addEventListener('DOMContentLoaded', fetchFollowedPosts2);


        function showUserOnScreen(post) {
            const token = localStorage.getItem('token');
            const decodeToken = parseJwt(token);
            console.log("145****", decodeToken)
            const parentElem = document.getElementById('todoCompleted');
            const childElem = document.createElement('li');
            console.log("posts h get ka", post)
            childElem.textContent = post.username + "---->" + post.body;
            childElem.id = `post-${post.id}`;

            const deleteButton = document.createElement('button');
            deleteButton.textContent = 'Delete Post';
            deleteButton.style.backgroundColor = 'red';
            deleteButton.style.color = 'white';
            deleteButton.onclick = () => deletePost(post.id);

            childElem.appendChild(deleteButton);
            parentElem.appendChild(childElem);
        }

        function showUserOnScreen2(post) {
            const token = localStorage.getItem('token');
            const decodeToken = parseJwt(token);
            console.log("145****", decodeToken)
            const parentElem = document.getElementById('followerPost');
            const childElem = document.createElement('li');
            console.log("posts h get ka", post)
            childElem.textContent = post.username + "---->" + post.body;
            childElem.id = `post-${post.id}`;

            // const deleteButton = document.createElement('button');
            // deleteButton.textContent = 'Delete Post';
            // deleteButton.style.backgroundColor = 'red';
            // deleteButton.style.color = 'white';
            // deleteButton.onclick = () => deletePost(post.id);

            // childElem.appendChild(deleteButton);
            parentElem.appendChild(childElem);
        }

        function showUserOnScreenforFandUF(user) {
            console.log('300%%%%%%%%%%%%%%%%%%', user)
            const token = localStorage.getItem('token');
            const decodeToken = parseJwt(token);
            console.log("145****", decodeToken)
            const parentElem = document.getElementById('allUsers');
            const childElem = document.createElement('li');
            console.log("posts h get ka", user)
            childElem.textContent = user.username
            childElem.id = `user-${user.id}`;

            const followButton = document.createElement('button');
            followButton.textContent = 'Follow User';
            followButton.style.backgroundColor = 'yellow'

            followButton.style.color = 'black';
            followButton.onclick = () => {
                followAndUnfollowUserforCount("follow")
                followAndUnfollowUser1(user.id)
                fetchFollowedPosts(user.id)
                followButton.disabled = true;
                followButton.style.backgroundColor = 'green';
                unfollowButton.disabled = false;

            }

            const unfollowButton = document.createElement('button');
            unfollowButton.textContent = 'Unfollow User';
            unfollowButton.style.backgroundColor = 'red';
            unfollowButton.style.color = 'black';
            unfollowButton.onclick = () => {
                followAndUnfollowUserforCount("unfollow")
                followAndUnfollowUser2(user.id)
                fetchFollowedPosts2(user.id)
                unfollowButton.disabled = true;
                followButton.disabled = false;
                followButton.style.backgroundColor = 'yellow';
            }

            if (followButton.style.backgroundColor === 'yellow') {
                unfollowButton.disabled = true;
            }
            childElem.appendChild(followButton);
            childElem.appendChild(unfollowButton);
            parentElem.appendChild(childElem);

        }
    </script>
</body>

</html>