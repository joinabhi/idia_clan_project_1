<!DOCTYPE html>
<html>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65" crossorigin="anonymous">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-kenU1KFdBIe4zVF0s0G1M5b4hcpxyD9F7jL+jjXkk+Q2h455rYXK/7HAuoJl+0I4"
    crossorigin="anonymous"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
<style>
    .pure-form {
        border-radius: 5px;
        background-color: #f2f2f2;
        padding: 20px;
    }

    table,
    th,
    tr {
        border: 1px solid black;
    }
</style>

<body>
    <form onsubmit="formSubmit(event)" class="pure-form">
        <fieldset>
            <label>Create a post:</label><br>
            <input type="text" placeholder="Needs to do.." name="name" id="nameIdd" required /><br>
            <button style="background-color:blue; border-color:red; color:white">Submit</button>
        </fieldset>
    </form>
 
    <h1>Recent Posts</h1>
    <ul id="todoCompleted"></ul>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/graphql-request/3.5.0/graphql-request.min.js"></script>
    <script>
        async function formSubmit(event) {
            event.preventDefault();
            const post = event.target.name.value;

            const mutation = `
                mutation AddPost($post: String!) {
                    addTodo(post: $post) {
                        id
                        post
                    }
                }
            `;

            try {
                const data = await request('http://localhost:7000/graphql', mutation, { post });
                console.log('Post added successfully:', data);
                showUserOnScreen(data.addTodo);
                document.forms[0].reset();
            } catch (error) {
                console.error('Error adding post:', error);
            }
        }

        async function fetchAllPosts() {
            const query = `
                {
                    allTodos {
                        id
                        post
                    }
                }
            `;

            try {
                const data = await request('http://localhost:7000/graphql', query);
                console.log('Fetched all posts:', data);
                data.allTodos.forEach(post => showUserOnScreen(post));
            } catch (error) {
                console.error('Error fetching posts:', error);
            }
        }

        async function deletePost(id) {
            const mutation = `
                mutation DeletePost($id: ID!) {
                    deleteTodo(id: $id)
                }
            `;

            try {
                await request('http://localhost:7000/graphql', mutation, { id });
                const postElem = document.getElementById(`post-${id}`);
                postElem.parentNode.removeChild(postElem);
            } catch (error) {
                console.error('Error deleting post:', error);
            }
        }

        function showUserOnScreen(post) {
            const parentElem = document.getElementById('todoCompleted');
            const childElem = document.createElement('li');
            childElem.textContent = post.post;
            childElem.id = `post-${post.id}`;

            const deleteButton = document.createElement('button');
            deleteButton.textContent = 'Delete Post';
            deleteButton.style.backgroundColor = 'red';
            deleteButton.style.color = 'white';
            deleteButton.onclick = () => deletePost(post.id);

            childElem.appendChild(deleteButton);
            parentElem.appendChild(childElem);
        }

        window.addEventListener('DOMContentLoaded', fetchAllPosts);
    </script>
</body>
</html>
